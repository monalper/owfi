import React, { useEffect, useState } from 'react';
import { Link, useSearchParams } from 'react-router-dom';
import { searchSymbols } from '../../api/yahooClient.js';
import SearchBar from '../../components/SearchBar/SearchBar.jsx';
import ListCard from '../../components/ListCard/ListCard.jsx';
import { PRESET_LISTS } from '../../config/lists.js';
import './SearchResultsPage.css';

const PAGE_SIZE = 20;

const LIST_TABS = [
  { id: 'us', label: 'ABD Borsası' },
  { id: 'bist', label: 'BIST' },
];

function SearchResultsPage() {
  const [searchParams] = useSearchParams();
  const query = searchParams.get('q') ?? '';
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [visibleCount, setVisibleCount] = useState(PAGE_SIZE);
  const [activeTab, setActiveTab] = useState(LIST_TABS[0].id);

  useEffect(() => {
    let cancelled = false;

    async function run() {
      const trimmed = query.trim();

      if (!trimmed) {
        setResults([]);
        setVisibleCount(PAGE_SIZE);
        return;
      }

      try {
        setLoading(true);
        setError(null);
        const data = await searchSymbols(trimmed);
        if (cancelled) return;
        setResults(data);
        setVisibleCount(PAGE_SIZE);
      } catch (err) {
        if (!cancelled) {
          setError(err.message || 'Arama sırasında bir hata oluştu.');
        }
      } finally {
        if (!cancelled) setLoading(false);
      }
    }

    run();

    return () => {
      cancelled = true;
    };
  }, [query]);

  useEffect(() => {
    function handleScroll() {
      if (loading || results.length === 0) return;

      const scrollPosition = window.innerHeight + window.scrollY;
      const threshold = document.body.offsetHeight - 200;

      if (scrollPosition >= threshold) {
        setVisibleCount((current) => {
          if (current >= results.length) return current;
          const next = Math.min(current + PAGE_SIZE, results.length);
          return next;
        });
      }
    }

    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, [loading, results.length]);

  const hasQuery = query.trim().length > 0;
  const hasResults = results.length > 0;

  const listItems = PRESET_LISTS.filter((item) => item.market === activeTab);

  return (
    <div className="search-page-root">
      <section className="search-page-header">
        <SearchBar autoFocus />
      </section>

      {!hasQuery && (
        <>
          <div className="search-page-tabs">
            {LIST_TABS.map((tab) => (
              <button
                key={tab.id}
                type="button"
                className={`search-page-tab${
                  tab.id === activeTab ? ' search-page-tab-active' : ''
                }`}
                onClick={() => setActiveTab(tab.id)}
              >
                {tab.label}
              </button>
            ))}
          </div>

          <section className="search-page-lists">
            {listItems.map((list) => (
              <ListCard
                key={list.id}
                to={`/lists/${list.id}`}
                icon={list.emoji}
                title={list.title}
              />
            ))}
          </section>
        </>
      )}

      {error && (
        <div className="search-page-error">
          <span>{error}</span>
        </div>
      )}

      {!hasQuery && !loading && !error && (
        <div className="search-page-empty">
          <span></span>
        </div>
      )}

      {hasQuery && !loading && !error && !hasResults && (
        <div className="search-page-empty">
          <span>"{query}" için sonuç bulunamadı.</span>
        </div>
      )}

      {loading && (
        <div className="search-page-loading">
          <span>Sonuçlar getiriliyor...</span>
        </div>
      )}

      {!loading && hasResults && (
        <section className="search-page-results">
          {results.slice(0, visibleCount).map((item) => (
            <Link
              key={`${item.symbol}-${item.exchange}`}
              to={`/asset/${encodeURIComponent(item.symbol)}`}
              className="search-page-row"
            >
              <div className="search-page-row-main">
                <div className="search-page-row-symbol">{item.symbol}</div>
                <div className="search-page-row-name">{item.shortname}</div>
              </div>
              <div className="search-page-row-meta">
                <span className="search-page-row-exchange">
                  {item.exchange}
                </span>
                <span className="search-page-row-type">{item.quoteType}</span>
              </div>
            </Link>
          ))}
        </section>
      )}
    </div>
  );
}

export default SearchResultsPage;


